<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat</title>
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
        />
        <style>
            input {
                display: block;
            }
            ul {
                list-style: none;
            }
            ul#messages {
                list-style: none;
            }
            ul#messages li {
                margin-bottom: 2px;
            }
            ul#messages li img {
                margin-right: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="panel panel-default">
                <div class="panel-body">
                    <ul id="messages"></ul>
                </div>
            </div>
            <form id="chatbox">
                <div class="form-group">
                    <label for="message"
                        >Send a message as {{.UserData.email}}
                    </label>
                    or <a href="/logout">Sign out</a>
                    <textarea
                        class="form-control"
                        name="message"
                        id="textarea"
                    ></textarea>
                </div>
                <input type="submit" value="Send" class="btn btn-default" />
            </form>
        </div>
        <script>
            let socket = null;
            let form = document.getElementById("chatbox");
            let msgBox = document.getElementById("textarea");
            let messages = document.getElementById("messages");
            form.onsubmit = function (e) {
                if (msgBox.value.length > 0) {
                    if (!socket) {
                        alert("Error: there is no socket connection");
                        return false;
                    }
                    socket.send(JSON.stringify({ Message: msgBox.value }));
                    msgBox.value = "";
                    return false;
                }
            };
            if (!window["WebSocket"]) {
                alert("Error: Your browser doesn't support web sockets");
            } else {
                socket = new WebSocket("ws://{{.Host}}/room");
                socket.onclose = function () {
                    alert("Connection has been closed.");
                };
                socket.onmessage = function (e) {
                    const msg = JSON.parse(e.data);

                    const child = document.createElement("li");
                    const span = document.createElement("span");
                    const img = document.createElement("img");
                    img.setAttribute(
                        "style",
                        "width: 50px;vertical-align:middle;border-radius:50%;margin-right:10px",
                    );
                    img.setAttribute("src", msg.AvatarURL);
                    span.textContent = msg.Message;
                    child.appendChild(img);
                    child.appendChild(span);

                    messages.appendChild(child);
                };
            }
        </script>
    </body>
</html>
